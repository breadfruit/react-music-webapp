{"ast":null,"code":"var _jsxFileName = \"/Users/macos/Desktop/react-music-webapp/src/application/Player/index.js\",\n    _s = $RefreshSig$();\n\nimport React, { useRef, useState, useEffect } from \"react\";\nimport { connect } from \"react-redux\";\nimport { changePlayingState, changeShowPlayList, changeCurrentIndex, changeCurrentSong, changePlayList, changePlayMode, changeFullScreen } from \"./store/actionCreators\";\nimport MiniPlayer from './miniPlayer';\nimport NormalPlayer from './normalPlayer';\nimport { getSongUrl, isEmptyObject, shuffle, findIndex } from \"../../api/utils\";\nimport { playMode } from '../../api/config';\nimport Toast from \"./../../baseUI/toast/index\";\nimport PlayList from './play-list/index';\nimport { getLyricRequest } from \"../../api/request\"; // import Lyric from './../../api/lyric-parser';\n\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction Player(props) {\n  _s();\n\n  //目前播放时间\n  const [currentTime, setCurrentTime] = useState(0); //歌曲总时长\n\n  const [duration, setDuration] = useState(0); //歌曲播放进度\n\n  let percent = isNaN(currentTime / duration) ? 0 : currentTime / duration;\n  const [currentPlayingLyric, setPlayingLyric] = useState(\"\");\n  const [preSong, setPreSong] = useState({});\n  const [modeText, setModeText] = useState(\"\");\n  const [songReady, setSongReady] = useState(true);\n  const audioRef = useRef();\n  const toastRef = useRef();\n  const currentLyric = useRef();\n  const currentLineNum = useRef(0);\n  const {\n    playing,\n    currentSong: immutableCurrentSong,\n    currentIndex,\n    playList: immutablePlayList,\n    mode,\n    //播放模式\n    sequencePlayList: immutableSequencePlayList,\n    //顺序列表\n    fullScreen\n  } = props;\n  const {\n    togglePlayingDispatch,\n    togglePlayListDispatch,\n    changeCurrentIndexDispatch,\n    changeCurrentDispatch,\n    changePlayListDispatch,\n    //改变playList\n    changeModeDispatch,\n    //改变mode\n    toggleFullScreenDispatch\n  } = props;\n  const playList = immutablePlayList.toJS();\n  const sequencePlayList = immutableSequencePlayList.toJS();\n  const currentSong = immutableCurrentSong.toJS();\n  useEffect(() => {\n    if (!playList.length || currentIndex === -1 || !playList[currentIndex] || playList[currentIndex].id === preSong.id || !songReady) return;\n    let current = playList[currentIndex];\n    setPreSong(current);\n    setSongReady(false);\n    changeCurrentDispatch(current); //赋值currentSong\n\n    audioRef.current.src = getSongUrl(current.id);\n    setTimeout(() => {\n      audioRef.current.play().then(() => {\n        setSongReady(true);\n      });\n    });\n    togglePlayingDispatch(true); //播放状态\n    // getLyric(current.id);\n\n    setCurrentTime(0); //从头开始播放\n\n    setDuration(current.dt / 1000 | 0); //时长\n    // eslint-disable-next-line\n  }, [playList, currentIndex]);\n  useEffect(() => {\n    playing ? audioRef.current.play() : audioRef.current.pause();\n  }, [playing]); // const handleLyric = ({ lineNum, txt }) => {\n  //   if(!currentLyric.current)return;\n  //   currentLineNum.current = lineNum;\n  //   setPlayingLyric(txt);\n  // };\n  // const getLyric = id => {\n  //   let lyric = \"\";\n  //   if (currentLyric.current) {\n  //     currentLyric.current.stop();\n  //   }\n  //   // 避免songReady恒为false的情况\n  //   getLyricRequest(id)\n  //     .then(data => {\n  //       lyric = data.lrc.lyric;\n  //       if(!lyric) {\n  //         currentLyric.current = null;\n  //         return;\n  //       }\n  //       currentLyric.current = new Lyric(lyric, handleLyric);\n  //       currentLyric.current.play();\n  //       currentLineNum.current = 0;\n  //       currentLyric.current.seek(0);\n  //     })\n  //     .catch(() => {\n  //       songReady.current = true;\n  //       audioRef.current.play();\n  //     });\n  // };\n\n  const clickPlaying = (e, state) => {\n    e.stopPropagation();\n    togglePlayingDispatch(state);\n\n    if (currentLyric.current) {\n      currentLyric.current.togglePlay(currentTime * 1000);\n    }\n  };\n\n  const updateTime = e => {\n    setCurrentTime(e.target.currentTime);\n  };\n\n  const onProgressChange = curPercent => {\n    const newTime = curPercent * duration;\n    setCurrentTime(newTime);\n    audioRef.current.currentTime = newTime;\n\n    if (!playing) {\n      togglePlayingDispatch(true);\n    }\n\n    if (currentLyric.current) {\n      currentLyric.current.seek(newTime * 1000);\n    }\n  }; //一首歌循环\n\n\n  const handleLoop = () => {\n    audioRef.current.currentTime = 0;\n    changePlayingState(true);\n    audioRef.current.play();\n  };\n\n  const handlePrev = () => {\n    //播放列表只有一首歌时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n\n    let index = currentIndex - 1;\n    if (index < 0) index = playList.length - 1;\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  };\n\n  const changeMode = () => {\n    let newMode = (mode + 1) % 3;\n\n    if (newMode === 0) {\n      //顺序模式\n      changePlayListDispatch(sequencePlayList);\n      let index = findIndex(currentSong, sequencePlayList);\n      changeCurrentIndexDispatch(index);\n      setModeText(\"顺序循环\");\n    } else if (newMode === 1) {\n      //单曲循环\n      changePlayListDispatch(sequencePlayList);\n      setModeText(\"单曲循环\");\n    } else if (newMode === 2) {\n      //随机播放\n      let newList = shuffle(sequencePlayList);\n      let index = findIndex(currentSong, newList);\n      changePlayListDispatch(newList);\n      changeCurrentIndexDispatch(index);\n      setModeText(\"随机播放\");\n    }\n\n    changeModeDispatch(newMode);\n    toastRef.current.show();\n  };\n\n  const handleNext = () => {\n    //播放列表只有一首歌时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n\n    let index = currentIndex + 1;\n    if (index === playList.length) index = 0;\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  };\n\n  const handleEnd = () => {\n    if (mode === playMode.loop) {\n      handleLoop();\n    } else {\n      handleNext();\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [isEmptyObject(currentSong) ? null : /*#__PURE__*/_jsxDEV(MiniPlayer, {\n      song: currentSong,\n      fullScreen: fullScreen,\n      playing: playing,\n      toggleFullScreen: toggleFullScreenDispatch,\n      clickPlaying: clickPlaying,\n      percent: percent,\n      changePlayListDispatch: changePlayListDispatch,\n      togglePlayList: togglePlayListDispatch\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 209,\n      columnNumber: 9\n    }, this), isEmptyObject(currentSong) ? null : /*#__PURE__*/_jsxDEV(NormalPlayer, {\n      song: currentSong,\n      fullScreen: fullScreen,\n      playing: playing,\n      mode: mode,\n      currentLyric: currentLyric.current,\n      currentPlayingLyric: currentPlayingLyric,\n      currentLineNum: currentLineNum.current,\n      changeMode: changeMode,\n      duration: duration,\n      currentTime: currentTime,\n      percent: percent,\n      toggleFullScreen: toggleFullScreenDispatch,\n      clickPlaying: clickPlaying,\n      onProgressChange: onProgressChange,\n      handlePrev: handlePrev,\n      handleNext: handleNext,\n      changePlayListDispatch: changePlayListDispatch,\n      togglePlayList: togglePlayListDispatch\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 222,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"audio\", {\n      ref: audioRef,\n      onTimeUpdate: updateTime,\n      onEnded: handleEnd\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 244,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(PlayList, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 249,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Toast, {\n      text: modeText,\n      ref: toastRef\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 250,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 207,\n    columnNumber: 5\n  }, this);\n} // 映射Redux全局的state到组件的props上\n\n\n_s(Player, \"tvp1bopYDEOx87NGUz84AVJvdg8=\");\n\n_c = Player;\n\nconst mapStateToProps = state => ({\n  fullScreen: state.getIn([\"player\", \"fullScreen\"]),\n  playing: state.getIn([\"player\", \"playing\"]),\n  currentSong: state.getIn([\"player\", \"currentSong\"]),\n  showPlayList: state.getIn([\"player\", \"showPlayList\"]),\n  mode: state.getIn([\"player\", \"mode\"]),\n  currentIndex: state.getIn([\"player\", \"currentIndex\"]),\n  playList: state.getIn([\"player\", \"playList\"]),\n  sequencePlayList: state.getIn([\"player\", \"sequencePlayList\"])\n}); // 映射dispatch到props上\n\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    togglePlayingDispatch(data) {\n      dispatch(changePlayingState(data));\n    },\n\n    toggleFullScreenDispatch(data) {\n      dispatch(changeFullScreen(data));\n    },\n\n    togglePlayListDispatch(data) {\n      dispatch(changeShowPlayList(data));\n    },\n\n    changeCurrentIndexDispatch(index) {\n      dispatch(changeCurrentIndex(index));\n    },\n\n    changeCurrentDispatch(data) {\n      dispatch(changeCurrentSong(data));\n    },\n\n    changeModeDispatch(data) {\n      dispatch(changePlayMode(data));\n    },\n\n    changePlayListDispatch(data) {\n      dispatch(changePlayList(data));\n    }\n\n  };\n}; // 将ui组件包装成容器组件\n\n\nexport default connect(mapStateToProps, mapDispatchToProps)( /*#__PURE__*/React.memo(Player));\n\nvar _c;\n\n$RefreshReg$(_c, \"Player\");","map":{"version":3,"sources":["/Users/macos/Desktop/react-music-webapp/src/application/Player/index.js"],"names":["React","useRef","useState","useEffect","connect","changePlayingState","changeShowPlayList","changeCurrentIndex","changeCurrentSong","changePlayList","changePlayMode","changeFullScreen","MiniPlayer","NormalPlayer","getSongUrl","isEmptyObject","shuffle","findIndex","playMode","Toast","PlayList","getLyricRequest","Player","props","currentTime","setCurrentTime","duration","setDuration","percent","isNaN","currentPlayingLyric","setPlayingLyric","preSong","setPreSong","modeText","setModeText","songReady","setSongReady","audioRef","toastRef","currentLyric","currentLineNum","playing","currentSong","immutableCurrentSong","currentIndex","playList","immutablePlayList","mode","sequencePlayList","immutableSequencePlayList","fullScreen","togglePlayingDispatch","togglePlayListDispatch","changeCurrentIndexDispatch","changeCurrentDispatch","changePlayListDispatch","changeModeDispatch","toggleFullScreenDispatch","toJS","length","id","current","src","setTimeout","play","then","dt","pause","clickPlaying","e","state","stopPropagation","togglePlay","updateTime","target","onProgressChange","curPercent","newTime","seek","handleLoop","handlePrev","index","changeMode","newMode","newList","show","handleNext","handleEnd","loop","mapStateToProps","getIn","showPlayList","mapDispatchToProps","dispatch","data","memo"],"mappings":"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","sourcesContent":["import React, { useRef, useState, useEffect } from \"react\";\nimport { connect } from \"react-redux\";\nimport {\n  changePlayingState,\n  changeShowPlayList,\n  changeCurrentIndex,\n  changeCurrentSong,\n  changePlayList,\n  changePlayMode,\n  changeFullScreen\n} from \"./store/actionCreators\";\nimport MiniPlayer from './miniPlayer';\nimport NormalPlayer from './normalPlayer';\nimport { getSongUrl, isEmptyObject, shuffle, findIndex } from \"../../api/utils\";\nimport { playMode } from '../../api/config';\nimport Toast from \"./../../baseUI/toast/index\";\nimport PlayList from './play-list/index';\nimport { getLyricRequest } from \"../../api/request\";\n// import Lyric from './../../api/lyric-parser';\nfunction Player(props) {\n  //目前播放时间\n  const [currentTime, setCurrentTime] = useState(0);\n  //歌曲总时长\n  const [duration, setDuration] = useState(0);\n  //歌曲播放进度\n  let percent = isNaN(currentTime / duration) ? 0 : currentTime / duration;\n  const [currentPlayingLyric, setPlayingLyric] = useState(\"\");\n  const [preSong, setPreSong] = useState({});\n  const [modeText, setModeText] = useState(\"\");\n  const [songReady, setSongReady] = useState(true);\n\n  const audioRef = useRef();\n  const toastRef = useRef();\n  const currentLyric = useRef();\n  const currentLineNum = useRef(0);\n\n  const {\n    playing,\n    currentSong:immutableCurrentSong,\n    currentIndex,\n    playList:immutablePlayList,\n    mode,//播放模式\n    sequencePlayList:immutableSequencePlayList,//顺序列表\n    fullScreen\n  } = props;\n  \n  const {\n    togglePlayingDispatch,\n    togglePlayListDispatch,\n    changeCurrentIndexDispatch,\n    changeCurrentDispatch,\n    changePlayListDispatch,//改变playList\n    changeModeDispatch,//改变mode\n    toggleFullScreenDispatch,\n  } = props;\n  \n  const playList = immutablePlayList.toJS();\n  const sequencePlayList = immutableSequencePlayList.toJS();\n  const currentSong = immutableCurrentSong.toJS();\n\n  useEffect(() => {\n    if (\n      !playList.length ||\n      currentIndex === -1 ||\n      !playList[currentIndex] ||\n      playList[currentIndex].id === preSong.id ||\n      !songReady\n    )\n      return;\n    let current = playList[currentIndex];\n    setPreSong(current);\n    setSongReady(false);\n    changeCurrentDispatch(current);//赋值currentSong\n    audioRef.current.src = getSongUrl(current.id);\n    setTimeout(() => {\n      audioRef.current.play().then(() => {\n        setSongReady(true);\n      });\n    });\n    togglePlayingDispatch(true);//播放状态\n    // getLyric(current.id);\n    setCurrentTime(0);//从头开始播放\n    setDuration((current.dt / 1000) | 0);//时长\n    // eslint-disable-next-line\n  }, [playList, currentIndex]);\n\n  useEffect(() => {\n    playing ? audioRef.current.play() : audioRef.current.pause();\n  }, [playing]);\n  \n  // const handleLyric = ({ lineNum, txt }) => {\n  //   if(!currentLyric.current)return;\n  //   currentLineNum.current = lineNum;\n  //   setPlayingLyric(txt);\n  // };\n  \n  // const getLyric = id => {\n  //   let lyric = \"\";\n  //   if (currentLyric.current) {\n  //     currentLyric.current.stop();\n  //   }\n  //   // 避免songReady恒为false的情况\n  //   getLyricRequest(id)\n  //     .then(data => {\n  //       lyric = data.lrc.lyric;\n  //       if(!lyric) {\n  //         currentLyric.current = null;\n  //         return;\n  //       }\n  //       currentLyric.current = new Lyric(lyric, handleLyric);\n  //       currentLyric.current.play();\n  //       currentLineNum.current = 0;\n  //       currentLyric.current.seek(0);\n  //     })\n  //     .catch(() => {\n  //       songReady.current = true;\n  //       audioRef.current.play();\n  //     });\n  // };\n\n  const clickPlaying = (e, state) => {\n    e.stopPropagation();\n    togglePlayingDispatch(state);\n    if(currentLyric.current) {\n      currentLyric.current.togglePlay(currentTime*1000);\n    }\n  };\n\n  const updateTime = e => {\n    setCurrentTime(e.target.currentTime);\n  };\n\n  const onProgressChange = curPercent => {\n    const newTime = curPercent * duration;\n    setCurrentTime(newTime);\n    audioRef.current.currentTime = newTime;\n    if (!playing) {\n      togglePlayingDispatch(true);\n    }\n    if (currentLyric.current) {\n      currentLyric.current.seek(newTime * 1000);\n    }\n  };\n  //一首歌循环\n  const handleLoop = () => {\n    audioRef.current.currentTime = 0;\n    changePlayingState(true);\n    audioRef.current.play();\n  };\n\n  const handlePrev = () => {\n    //播放列表只有一首歌时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n    let index = currentIndex - 1;\n    if (index < 0) index = playList.length - 1;\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  };\n\n  const changeMode = () => {\n    let newMode = (mode + 1) % 3;\n    if (newMode === 0) {\n      //顺序模式\n      changePlayListDispatch(sequencePlayList);\n      let index = findIndex(currentSong, sequencePlayList);\n      changeCurrentIndexDispatch(index);\n      setModeText(\"顺序循环\");\n    } else if (newMode === 1) {\n      //单曲循环\n      changePlayListDispatch(sequencePlayList);\n      setModeText(\"单曲循环\");\n    } else if (newMode === 2) {\n      //随机播放\n      let newList = shuffle(sequencePlayList);\n      let index = findIndex(currentSong, newList);\n      changePlayListDispatch(newList);\n      changeCurrentIndexDispatch(index);\n      setModeText(\"随机播放\");\n    }\n    changeModeDispatch(newMode);\n    toastRef.current.show();\n  };\n\n  const handleNext = () => {\n    //播放列表只有一首歌时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n    let index = currentIndex + 1;\n    if (index === playList.length) index = 0;\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  };\n\n  const handleEnd = () => {\n    if (mode === playMode.loop) {\n      handleLoop();\n    } else {\n      handleNext();\n    }\n  };\n  return (\n    <div>\n      { isEmptyObject(currentSong) ? null : (\n        <MiniPlayer\n          song={currentSong}\n          fullScreen={fullScreen}\n          playing={playing}\n          toggleFullScreen={toggleFullScreenDispatch}\n          clickPlaying={clickPlaying}\n          percent={percent}\n          changePlayListDispatch={changePlayListDispatch}\n          togglePlayList={togglePlayListDispatch}\n        /> \n        )\n      }\n      { isEmptyObject(currentSong) ? null : (\n        <NormalPlayer\n          song={currentSong}\n          fullScreen={fullScreen}\n          playing={playing}\n          mode={mode}\n          currentLyric={currentLyric.current}\n          currentPlayingLyric={currentPlayingLyric}\n          currentLineNum={currentLineNum.current}\n          changeMode={changeMode}\n          duration={duration}\n          currentTime={currentTime}\n          percent={percent}\n          toggleFullScreen={toggleFullScreenDispatch}\n          clickPlaying={clickPlaying}\n          onProgressChange={onProgressChange}\n          handlePrev={handlePrev}\n          handleNext={handleNext}\n          changePlayListDispatch={changePlayListDispatch}\n          togglePlayList={togglePlayListDispatch}\n        />\n        )\n      }\n      <audio\n        ref={audioRef}\n        onTimeUpdate={updateTime}\n        onEnded={handleEnd}\n      ></audio>\n      <PlayList></PlayList>\n      <Toast text={modeText} ref={toastRef}></Toast>  \n    </div>\n  )\n}\n\n// 映射Redux全局的state到组件的props上\nconst mapStateToProps = state => ({\n  fullScreen: state.getIn([\"player\", \"fullScreen\"]),\n  playing: state.getIn([\"player\", \"playing\"]),\n  currentSong: state.getIn([\"player\", \"currentSong\"]),\n  showPlayList: state.getIn([\"player\", \"showPlayList\"]),\n  mode: state.getIn([\"player\", \"mode\"]),\n  currentIndex: state.getIn([\"player\", \"currentIndex\"]),\n  playList: state.getIn([\"player\", \"playList\"]),\n  sequencePlayList: state.getIn([\"player\", \"sequencePlayList\"])\n});\n\n// 映射dispatch到props上\nconst mapDispatchToProps = dispatch => {\n  return {\n    togglePlayingDispatch(data) {\n      dispatch(changePlayingState(data));\n    },\n    toggleFullScreenDispatch(data) {\n      dispatch(changeFullScreen(data));\n    },\n    togglePlayListDispatch(data) {\n      dispatch(changeShowPlayList(data));\n    },\n    changeCurrentIndexDispatch(index) {\n      dispatch(changeCurrentIndex(index));\n    },\n    changeCurrentDispatch(data) {\n      dispatch(changeCurrentSong(data));\n    },\n    changeModeDispatch(data) {\n      dispatch(changePlayMode(data));\n    },\n    changePlayListDispatch(data) {\n      dispatch(changePlayList(data));\n    }\n  };\n};\n\n// 将ui组件包装成容器组件\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(React.memo(Player));"]},"metadata":{},"sourceType":"module"}